{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Full Trainer Profile Page -->
<div class="container mt-5">
    <div class="row">
        <div class="col-12 text-center">
            <img src="{{ trainer.featured_image.url }}" class="profile-image"
                alt="photo of {{ trainer.first_name }} {{ trainer.last_name }}">
            <h2 class="mt-3">{{ trainer.first_name }} {{ trainer.last_name }}</h2>
            <p class="age"><strong>Age:</strong> {{ trainer.age }}</p>

            <!-- Display star rating -->
            <div class="star-rating" role="group" aria-labelledby="rating">
                {% for i in stars_range %}
                {% if i <= avg_rating %}
                <span class="fa fa-star checked" aria-label="full star" role="img"></span>
                {% elif i == avg_rating|add:0.5 %}
                <span class="fa fa-star-half-alt checked" aria-label="half star" role="img"></span>
                {% else %}
                <span class="fa fa-star" aria-label="empty star" role="img"></span>
                {% endif %}
                {% endfor %}
                <span id="rating" class="sr-only">Rating: {{ avg_rating }} out of 5 stars</span>
            </div>
        </div>
    </div>
</div>

<div class="about-section">
    <h3>About {{ trainer.first_name }}:</h3>
    <p>{{ trainer.description }}</p>
</div>

<div class="row mt-4">
    <div class="col-12">
        <h3 class="feedback-item comment-h3">Comments:</h3>

        {% if feedbacks %}
        <!-- Loop through the feedbacks and display each comment and individual rating -->
        {% for feedback in feedbacks %}
        <div class="feedback-item" id="feedback-{{ feedback.id }}">
            <!-- Star Rating Display -->
            <div class="star-rating" role="group" aria-labelledby="rating">
                {% for i in stars_range %}
                {% if i <= feedback.rating %}
                <span class="fa fa-star checked" aria-label="full star" role="img"></span>
                {% elif i == feedback.rating|add:0.5 %}
                <span class="fa fa-star-half-alt checked" aria-label="half star" role="img"></span>
                {% else %}
                <span class="fa fa-star" aria-label="empty star" role="img"></span>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Display the username and the comment -->
            <p><strong><span>{{ feedback.user.username }}:</span></strong>
                <span id="comment-text-{{ feedback.id }}">
                    {{ feedback.comment|safe }}
                </span>

                <!-- Form to edit the comment (Initially hidden) -->
                <form method="POST" action="{% url 'trainers:edit_feedback' feedback.id %}" style="display:none;"
                    id="edit-form-{{ feedback.id }}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="comment-{{ feedback.id }}" class="text-light">Edit Comment:</label>
                        <textarea name="comment" id="comment-{{ feedback.id }}" class="form-control"
                            rows="4">{{ feedback.comment }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Save Changes</button>
                </form>
            </p>

            <!-- Add Edit and Delete buttons if the user is the owner of the comment -->
            {% if feedback.user == user %}
            <div class="comment-actions">
                <!-- Edit Button -->
                <button class="btn btn-primary btn-sm" onclick="toggleEditForm({{ feedback.id }})">Edit</button>

                <!-- Delete Button -->
                <form action="{% url 'trainers:delete_feedback' feedback.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p>No comments yet. Be the first to leave feedback!</p>
        {% endif %}
    </div>
</div>


<!-- Comment field, only visible if signed in -->
{% if user.is_authenticated %}
<form action="{% url 'trainers:submit_feedback' trainer.id %}" method="POST">
    <div class="user-comment-box">
        <h3><span>Leave your feedback!</span></h3>
        <p>Writing your comment as <strong>{{ user.username }}</strong></p>
        <textarea class="text-box" name="comment" placeholder="Write your comment here..."></textarea>
        <p>Leave a star review</p>
        {% csrf_token %}
        <div class="mb-3">
            <label for="rating" class="form-label">Rating</label>
            <select class="form-select" id="rating" name="rating" required>
                <option value="1">1&nbsp;★</option>
                <option value="2">2&nbsp;★</option>
                <option value="3">3&nbsp;★</option>
                <option value="4">4&nbsp;★</option>
                <option value="5">5&nbsp;★</option>
            </select>
            <button class="form-btn" type="submit">
                Submit
            </button>
        </div>
    </div>
</form>
{% else %}
<h3 class="user-comment-box">Create an account or sign in to leave your feedback!</h3>
{% endif %}

{% endblock %}